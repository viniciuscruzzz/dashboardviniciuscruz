<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Premium Q1 2025</title>
    <!-- Importando Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Importando Fonte Moderna (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Paleta de Cores Modernas */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            /* Novo gradiente de fundo, mais vibrante */
            --bg-gradient-dynamic: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%); 
            
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --accent-color: #6b46c1; /* Roxo Moderno */
            
            /* Cores Gráficos (Vivid) */
            --color-1: #FF0080; /* Rosa Neon */
            --color-2: #7928CA; /* Roxo Vivo */
            --color-3: #00DFD8; /* Turquesa */
            --color-4: #FF005C; /* Vermelho/Rosa */
            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --radius: 20px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: var(--bg-gradient-dynamic); 
            color: var(--text-primary); 
            padding: 30px;
            min-height: 100vh;
            background-attachment: fixed; 
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Header Styling */
        header { 
            margin-bottom: 35px; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: space-between; 
            align-items: flex-end; 
            gap: 20px;
        }

        .header-title h1 { 
            font-size: 2.2rem; 
            font-weight: 800; 
            letter-spacing: -1px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .header-title p {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Control Bar styling */
        .controls-container {
            background: var(--glass-bg);
            padding: 15px 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            border: var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label { 
            font-size: 0.75rem; 
            font-weight: 700; 
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }
        
        select { 
            padding: 10px 15px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            background-color: #fff; 
            font-weight: 600; 
            color: var(--text-primary); 
            cursor: pointer; 
            outline: none; 
            min-width: 130px;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        select:hover { border-color: #cbd5e0; }
        select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.1); }
        
        .btn-reset {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 18px; 
        }
        .btn-reset:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }

        /* Currency Toggle specific style */
        #currencySelector {
            background: #edf2f7;
            border: none;
            color: var(--accent-color);
        }

        /* KPIs Section */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 35px; }
        
        .kpi-card { 
            background: #fff; 
            padding: 25px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow-md); 
            position: relative; 
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .kpi-card:hover { transform: translateY(-5px); }

        /* Decorative gradient bar on top */
        .kpi-card::after { 
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; 
            background: linear-gradient(90deg, var(--color-1), var(--color-2));
        }
        .kpi-card.c2::after { background: linear-gradient(90deg, var(--color-3), var(--color-2)); }
        .kpi-card.c3::after { background: linear-gradient(90deg, var(--color-4), var(--color-1)); }
        
        .kpi-label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 10px; text-transform: uppercase; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: var(--text-primary); letter-spacing: -1px; }
        
        /* Trend Badges */
        .trend-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 6px 12px; border-radius: 50px;
            font-size: 0.8rem; font-weight: 700; margin-top: 12px;
        }
        .trend-up { background: #def7ec; color: #03543f; }
        .trend-down { background: #fde8e8; color: #9b1c1c; }
        .trend-neutral { background: #f3f4f6; color: #4b5563; }

        /* Sections Titles */
        .section-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
        }
        .section-title { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); }
        .section-icon { 
            background: var(--accent-color); color: white; 
            width: 32px; height: 32px; border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }

        /* Cards Grid (Produtos Estrela) */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; margin-bottom: 35px; }
        
        .seller-card { 
            background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow-sm); 
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #f0f0f0;
        }
        .seller-info h4 { font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; }
        .top-product-badge { background: #ebf8ff; color: #2b6cb0; padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; }
        .seller-total strong { font-size: 1.2rem; color: var(--accent-color); }

        /* Table Styling */
        .table-section { background: white; padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow-md); margin-bottom: 35px; overflow-x: auto; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { text-align: left; padding: 15px; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #f0f0f0; }
        td { padding: 15px; border-bottom: 1px solid #f7fafc; color: var(--text-primary); font-weight: 500; }
        tr:last-child td { border-bottom: none; }
        
        .badge-price { padding: 6px 12px; border-radius: 30px; font-size: 0.75rem; font-weight: 700; }
        .high-ticket { background: #e6fffa; color: #2c7a7b; }
        .mid-ticket { background: #fffaf0; color: #c05621; }
        .low-ticket { background: #fff5f5; color: #c53030; }

        /* Charts Grid */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(550px, 1fr)); gap: 30px; }
        
        .chart-card { 
            background: white; padding: 30px; border-radius: var(--radius); 
            box-shadow: var(--shadow-md); height: 450px; 
            display: flex; flex-direction: column;
        }
        
        .chart-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .chart-title-text { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        
        .canvas-container { flex-grow: 1; position: relative; width: 100%; }

        @media (max-width: 768px) {
            .controls-container { flex-direction: column; align-items: stretch; }
            .btn-reset { margin-top: 0; }
            .charts-grid { grid-template-columns: 1fr; }
            .header-title h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="header-title">
                <h1>Dashboard Vendas Q1</h1>
                <p>Análise Premium de Performance</p>
            </div>
            
            <div class="controls-container">
                <div class="filter-group">
                    <label>Moeda</label>
                    <select id="currencySelector" onchange="changeCurrency()">
                        <option value="EUR">Euro (€)</option>
                        <option value="USD">Dólar ($)</option>
                        <option value="BRL">Real (R$)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Mês</label>
                    <select id="filterMonth" onchange="updateDashboard()">
                        <option value="all">Todos os Meses</option>
                        <option value="0">Janeiro</option>
                        <option value="1">Fevereiro</option>
                        <option value="2">Março</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Região</label>
                    <select id="filterRegion" onchange="updateDashboard()"><option value="all">Todas</option></select>
                </div>

                <div class="filter-group">
                    <label>Vendedor</label>
                    <select id="filterSeller" onchange="updateDashboard()"><option value="all">Todos</option></select>
                </div>

                <button class="btn-reset" onclick="resetFilters()">Limpar Filtros</button>
            </div>
        </header>

        <!-- KPIs -->
        <section class="kpi-grid">
            <div class="kpi-card c1">
                <div class="kpi-label">Faturação Total</div>
                <div class="kpi-value" id="kpiSales">€ 0,00</div>
                <div id="trendSales" class="trend-badge trend-neutral"><span>--%</span></div>
            </div>
            <div class="kpi-card c2">
                <div class="kpi-label">Unidades Vendidas</div>
                <div class="kpi-value" id="kpiUnits">0</div>
                <div id="trendUnits" class="trend-badge trend-neutral"><span>--%</span></div>
            </div>
            <div class="kpi-card c3">
                <div class="kpi-label">Ticket Médio (Por Fatura)</div>
                <div class="kpi-value" id="kpiTicket">€ 0,00</div>
            </div>
        </section>

        <!-- Produto Estrela -->
        <section class="best-sellers-section">
            <div class="section-header">
                <div class="section-icon">★</div>
                <div class="section-title">Destaques da Equipa</div>
            </div>
            <div class="cards-grid" id="sellerCardsContainer"></div>
        </section>

        <!-- Tabela -->
        <section class="table-section">
            <div class="section-header">
                <div class="section-icon">☰</div>
                <div class="section-title">Detalhe de Produtos & Preços</div>
            </div>
            <table id="productTable">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Preço Unit.</th>
                        <th>Qtd.</th>
                        <th>Total</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- Gráficos -->
        <section class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title-text">Performance por Região</span>
                </div>
                <div class="canvas-container"><canvas id="chartRegion"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title-text">Ranking Vendedores</span>
                </div>
                <div class="canvas-container"><canvas id="chartSeller"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title-text">Mix de Produtos</span>
                </div>
                <div class="canvas-container"><canvas id="chartProduct"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title-text">Evolução Mensal</span>
                    <div id="chartTimeSubtitle" class="trend-badge trend-neutral" style="margin:0; font-size:0.7rem;">--</div>
                </div>
                <div class="canvas-container"><canvas id="chartTime"></canvas></div>
            </div>
        </section>
    </div>

    <script>
        // --- DADOS ---
        const rawData = [
            { id: 1, date: '2025-01-02', region: 'Norte', seller: 'João Silva', product: 'Portátil Pro 15"', units: 2, price: 1200, total: 2400 },
            { id: 2, date: '2025-01-05', region: 'Lisboa', seller: 'Ana Gomes', product: 'Monitor 27"', units: 5, price: 300, total: 1500 },
            { id: 3, date: '2025-01-10', region: 'Algarve', seller: 'Pedro Costa', product: 'Teclado Mecânico', units: 10, price: 150, total: 1500 },
            { id: 4, date: '2025-01-15', region: 'Norte', seller: 'João Silva', product: 'Rato Ergonómico', units: 8, price: 80, total: 640 },
            { id: 5, date: '2025-01-22', region: 'Centro', seller: 'Maria Neves', product: 'Portátil Pro 13"', units: 3, price: 1000, total: 3000 },
            { id: 6, date: '2025-02-05', region: 'Lisboa', seller: 'Ana Gomes', product: 'Portátil Pro 15"', units: 1, price: 1200, total: 1200 },
            { id: 7, date: '2025-02-12', region: 'Algarve', seller: 'Pedro Costa', product: 'Monitor 24"', units: 4, price: 200, total: 800 },
            { id: 8, date: '2025-02-18', region: 'Centro', seller: 'Maria Neves', product: 'Docking Station', units: 6, price: 180, total: 1080 },
            { id: 9, date: '2025-03-03', region: 'Norte', seller: 'João Silva', product: 'Headset Wireless', units: 7, price: 120, total: 840 },
            { id: 10, date: '2025-03-15', region: 'Lisboa', seller: 'Ana Gomes', product: 'Portátil Pro 13"', units: 2, price: 1000, total: 2000 }
        ];

        let currentCurrency = 'EUR';
        const exchangeRates = {
            'EUR': { rate: 1, locale: 'pt-PT', currency: 'EUR' },
            'USD': { rate: 1.05, locale: 'en-US', currency: 'USD' },
            'BRL': { rate: 6.15, locale: 'pt-BR', currency: 'BRL' }
        };

        let charts = {};
        // Paleta moderna
        const colors = { 
            vivid: ['#FF0080', '#7928CA', '#00DFD8', '#FF005C', '#F5A623', '#4A90E2', '#BD10E0', '#50E3C2'],
            bg: ['rgba(255, 0, 128, 0.7)', 'rgba(121, 40, 202, 0.7)', 'rgba(0, 223, 216, 0.7)', 'rgba(255, 0, 92, 0.7)']
        };

        window.onload = function() {
            populateFilters();
            initCharts();
            updateDashboard();
        };

        function formatCurrency(val) {
            const config = exchangeRates[currentCurrency];
            const convertedVal = val * config.rate;
            return new Intl.NumberFormat(config.locale, { style: 'currency', currency: config.currency }).format(convertedVal);
        }

        function changeCurrency() {
            currentCurrency = document.getElementById('currencySelector').value;
            updateDashboard();
        }

        function populateFilters() {
            const regions = [...new Set(rawData.map(d => d.region))];
            const sellers = [...new Set(rawData.map(d => d.seller))];
            fillSelect('filterRegion', regions); fillSelect('filterSeller', sellers);
            // Meses já estão hardcoded no HTML
        }

        function fillSelect(id, items) {
            const select = document.getElementById(id);
            items.forEach(item => { const opt = document.createElement('option'); opt.value = item; opt.innerText = item; select.appendChild(opt); });
        }

        function getFilteredData() {
            const r = document.getElementById('filterRegion').value;
            const s = document.getElementById('filterSeller').value;
            const m = document.getElementById('filterMonth').value; // Novo filtro

            return rawData.filter(item => {
                // Extrair mês do item (0, 1, 2)
                const itemMonth = new Date(item.date).getMonth().toString();
                
                return (r === 'all' || item.region === r) &&
                       (s === 'all' || item.seller === s) &&
                       (m === 'all' || itemMonth === m);
            });
        }

        function resetFilters() {
            document.getElementById('filterRegion').value = 'all';
            document.getElementById('filterSeller').value = 'all';
            document.getElementById('filterMonth').value = 'all';
            updateDashboard();
        }

        function updateDashboard() {
            const data = getFilteredData();
            updateKPIs(data);
            updateSellerBestProducts(data);
            updateProductTable(data);
            updateChartsData(data);
        }

        function updateKPIs(data) {
            const totalSales = data.reduce((sum, item) => sum + item.total, 0);
            const totalUnits = data.reduce((sum, item) => sum + item.units, 0);
            const avgTicket = data.length > 0 ? totalSales / data.length : 0;

            document.getElementById('kpiSales').innerText = formatCurrency(totalSales);
            document.getElementById('kpiUnits').innerText = totalUnits;
            document.getElementById('kpiTicket').innerText = formatCurrency(avgTicket);

            const isMonthFiltered = document.getElementById('filterMonth').value !== 'all';
            
            if(isMonthFiltered || data.length === 0) {
                document.getElementById('trendSales').style.display = 'none';
                document.getElementById('trendUnits').style.display = 'none';
            } else {
                document.getElementById('trendSales').style.display = 'inline-flex';
                document.getElementById('trendUnits').style.display = 'inline-flex';
                calculateTrends(data);
            }
        }

        function calculateTrends(data) {
            const monthlySales = {};
            const monthlyUnits = {};
            data.forEach(d => {
                const month = new Date(d.date).getMonth();
                monthlySales[month] = (monthlySales[month] || 0) + d.total;
                monthlyUnits[month] = (monthlyUnits[month] || 0) + d.units;
            });

            const activeMonths = Object.keys(monthlySales).map(Number).sort((a,b) => a-b);
            const lastMonth = activeMonths[activeMonths.length - 1];
            const prevMonth = activeMonths[activeMonths.length - 2];

            updateTrendBadge('trendSales', monthlySales[lastMonth], monthlySales[prevMonth]);
            updateTrendBadge('trendUnits', monthlyUnits[lastMonth], monthlyUnits[prevMonth]);
        }

        function updateTrendBadge(elementId, current, previous) {
            const el = document.getElementById(elementId);
            if (previous === undefined || previous === 0) {
                el.className = 'trend-badge trend-neutral'; el.innerHTML = '<span>Novo</span>'; return;
            }
            const percent = ((current - previous) / previous) * 100;
            const isUp = percent >= 0;
            el.className = `trend-badge ${isUp ? 'trend-up' : 'trend-down'}`;
            el.innerHTML = `<span>${isUp ? '▲' : '▼'} ${Math.abs(percent).toFixed(1)}%</span>`;
        }

        function updateSellerBestProducts(data) {
            const container = document.getElementById('sellerCardsContainer');
            container.innerHTML = '';
            if(data.length === 0) { container.innerHTML = '<p style="color:#777; padding:10px;">Nenhum dado para este filtro.</p>'; return; }

            const sellersMap = {};
            data.forEach(item => {
                if (!sellersMap[item.seller]) sellersMap[item.seller] = { name: item.seller, totalSales: 0, products: {} };
                sellersMap[item.seller].totalSales += item.total;
                if (!sellersMap[item.seller].products[item.product]) sellersMap[item.seller].products[item.product] = 0;
                sellersMap[item.seller].products[item.product] += item.total;
            });

            Object.values(sellersMap).forEach(s => {
                let topProduct = ''; let maxVal = -1;
                for (const [prod, val] of Object.entries(s.products)) { if (val > maxVal) { maxVal = val; topProduct = prod; } }
                const card = document.createElement('div');
                card.className = 'seller-card';
                card.innerHTML = `
                    <div class="seller-info">
                        <h4>${s.name}</h4>
                        <div class="top-product-badge">★ ${topProduct}</div>
                    </div>
                    <div class="seller-total">
                        <span style="font-size:0.7rem; color:#999; display:block;">Vendas</span>
                        <strong>${formatCurrency(s.totalSales)}</strong>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateProductTable(data) {
            const tbody = document.querySelector('#productTable tbody');
            tbody.innerHTML = '';
            if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#777;">Sem dados encontrados.</td></tr>'; return; }

            const productsMap = {};
            data.forEach(item => {
                if(!productsMap[item.product]) productsMap[item.product] = { name: item.product, price: item.price, units: 0, total: 0 };
                productsMap[item.product].units += item.units;
                productsMap[item.product].total += item.total;
            });

            Object.values(productsMap).sort((a,b) => b.total - a.total).forEach(p => {
                const tr = document.createElement('tr');
                let badgeClass = p.price >= 1000 ? 'high-ticket' : (p.price >= 200 ? 'mid-ticket' : 'low-ticket');
                let badgeLabel = p.price >= 1000 ? 'Alto' : (p.price >= 200 ? 'Médio' : 'Baixo');
                tr.innerHTML = `
                    <td style="font-weight:600; color:#2d3748;">${p.name}</td>
                    <td style="font-family:'Consolas', monospace; color:#718096;">${formatCurrency(p.price)}</td>
                    <td style="text-align:center;">${p.units}</td>
                    <td style="font-weight:700; color:var(--accent-color);">${formatCurrency(p.total)}</td>
                    <td><span class="badge-price ${badgeClass}">${badgeLabel}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function initCharts() {
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#718096';
            const optionsBase = { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                layout: { padding: 10 }
            };
            
            charts.region = new Chart(document.getElementById('chartRegion'), { type: 'bar', data: {}, options: { ...optionsBase, scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f0f0f0' } }, x: { grid: { display: false } } } } }); 
            charts.seller = new Chart(document.getElementById('chartSeller'), { type: 'bar', data: {}, options: { ...optionsBase, indexAxis: 'y', scales: { x: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f0f0f0' } }, y: { grid: { display: false } } } } });
            charts.product = new Chart(document.getElementById('chartProduct'), { type: 'doughnut', data: {}, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } } } } });
            charts.time = new Chart(document.getElementById('chartTime'), { type: 'line', data: {}, options: { ...optionsBase, scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f0f0f0' } }, x: { grid: { display: false } } } } });
        }

        function aggregateData(data, key) {
            const map = {};
            data.forEach(d => {
                let label = d[key];
                if (key === 'date') label = ['Jan', 'Fev', 'Mar'][new Date(d.date).getMonth()];
                map[label] = (map[label] || 0) + d.total;
            });
            return { labels: Object.keys(map), values: Object.values(map) };
        }

        function updateChartsData(data) {
            const update = (chart, agg, type='bar') => {
                chart.data.labels = agg.labels;
                chart.data.datasets = [{
                    label: 'Vendas', data: agg.values, 
                    backgroundColor: colors.vivid, 
                    borderColor: 'transparent', 
                    borderRadius: 8, 
                    barThickness: 30,
                    hoverBackgroundColor: colors.vivid[0] 
                }];
                
                if(type === 'line') {
                    chart.data.datasets[0].borderColor = colors.vivid[1];
                    chart.data.datasets[0].backgroundColor = 'rgba(121, 40, 202, 0.1)';
                    chart.data.datasets[0].borderWidth = 3;
                    chart.data.datasets[0].pointBackgroundColor = 'white';
                    chart.data.datasets[0].pointBorderColor = colors.vivid[1];
                    chart.data.datasets[0].pointRadius = 4;
                    chart.data.datasets[0].fill = true;
                    chart.data.datasets[0].tension = 0.4;

                    // Custom Tooltip Logic for Line Chart (Monthly variation)
                    chart.options.plugins.tooltip.callbacks.label = function(context) {
                        let label = ' ' + formatCurrency(context.raw);
                        // Check if there is a previous point
                        if (context.dataIndex > 0) {
                            const current = context.raw;
                            const previous = context.chart.data.datasets[0].data[context.dataIndex - 1];
                            if (previous && previous !== 0) {
                                const percent = ((current - previous) / previous) * 100;
                                const sign = percent > 0 ? '+' : '';
                                const symbol = percent > 0 ? '▲' : '▼';
                                label += ` (${symbol} ${sign}${percent.toFixed(1)}% vs mês anterior)`;
                            }
                        }
                        return label;
                    };
                } else if (type === 'doughnut') {
                   chart.data.datasets[0].backgroundColor = colors.vivid;
                   chart.data.datasets[0].borderColor = 'white';
                   chart.data.datasets[0].borderWidth = 2;
                   // Reset default label callback for non-line charts
                   chart.options.plugins.tooltip.callbacks.label = function(context) {
                        return ' ' + formatCurrency(context.raw);
                   };
                } else {
                   // Bar Charts
                   chart.data.datasets[0].backgroundColor = agg.values.map((_, i) => colors.vivid[i % colors.vivid.length]);
                   // Reset default label callback for non-line charts
                   chart.options.plugins.tooltip.callbacks.label = function(context) {
                        return ' ' + formatCurrency(context.raw);
                   };
                }

                // Tooltips general styling
                chart.options.plugins.tooltip.backgroundColor = 'rgba(45, 55, 72, 0.9)';
                chart.options.plugins.tooltip.padding = 10;
                chart.options.plugins.tooltip.cornerRadius = 8;
                
                // Format Axis
                if (type !== 'doughnut') {
                    const axis = type === 'bar' && chart.config.type === 'bar' && chart.options.indexAxis !== 'y' ? 'y' : (chart.options.indexAxis === 'y' ? 'x' : 'y');
                    chart.options.scales[axis].ticks.callback = function(value) { return formatCurrency(value); };
                }
                chart.update();
            };

            update(charts.region, aggregateData(data, 'region'));
            update(charts.seller, aggregateData(data, 'seller'));
            update(charts.product, aggregateData(data, 'product'), 'doughnut');
            
            // Gráfico de Tempo
            const tData = aggregateData(data, 'date');
            const order = ['Jan', 'Fev', 'Mar'];
            const sorted = tData.labels.map((l, i) => ({l, v: tData.values[i]})).sort((a, b) => order.indexOf(a.l) - order.indexOf(b.l));
            update(charts.time, { labels: sorted.map(x => x.l), values: sorted.map(x => x.v) }, 'line');
            
            // Atualizar subtítulo do gráfico de tempo
            const subtitle = document.getElementById('chartTimeSubtitle');
            if(sorted.length >= 2) {
                const last = sorted[sorted.length-1].v;
                const prev = sorted[sorted.length-2].v;
                const pc = ((last - prev) / prev) * 100;
                const sign = pc >= 0 ? '+' : '';
                subtitle.innerText = `Último Mês: ${sign}${pc.toFixed(1)}%`;
                subtitle.className = pc >= 0 ? 'trend-badge trend-up' : 'trend-badge trend-down';
                subtitle.style.display = 'inline-flex';
            } else {
                subtitle.style.display = 'none';
            }
        }
    </script>
</body>
</html>
