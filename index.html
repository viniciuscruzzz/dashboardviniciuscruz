<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Interativo Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-gradient-dynamic: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%); 
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --accent-color: #6b46c1; 
            --color-actual: #7928CA;
            --color-projected: #FF0080;
            --color-recovery: #00E096; /* Verde para a recupera√ß√£o */
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --radius: 20px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-image: var(--bg-gradient-dynamic); 
            color: var(--text-primary); 
            padding: 30px;
            min-height: 100vh;
            background-attachment: fixed; 
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        header { margin-bottom: 30px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-end; gap: 20px; }
        .header-title h1 { font-size: 2.2rem; font-weight: 800; letter-spacing: -1px; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .header-title p { color: var(--text-secondary); font-weight: 500; }
        
        /* Controls */
        .controls-container {
            background: var(--glass-bg); padding: 15px 25px; border-radius: var(--radius);
            box-shadow: var(--shadow-md); display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
            border: var(--glass-border); backdrop-filter: blur(10px);
        }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); }
        
        select { padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-weight: 600; color: var(--text-primary); cursor: pointer; outline: none; min-width: 130px; }
        select:focus { border-color: var(--accent-color); }
        
        .btn-reset { background: var(--primary-gradient); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 18px; }
        .btn-reset:hover { transform: translateY(-2px); }
        
        /* Simulation Panel */
        .simulation-section {
            background: #fff; border-radius: var(--radius); padding: 25px;
            box-shadow: var(--shadow-md); margin-bottom: 35px;
            border-left: 6px solid var(--color-projected);
            display: flex; flex-wrap: wrap; gap: 30px; align-items: center;
        }
        .sim-controls { flex: 2; min-width: 300px; }
        .sim-results { flex: 1; min-width: 250px; display: flex; gap: 15px; background: #f7fafc; padding: 20px; border-radius: 15px; }
        
        .scenario-buttons { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .scenario-btn { padding: 8px 14px; border: 2px solid #e2e8f0; background: transparent; border-radius: 10px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: 0.2s; }
        .scenario-btn.active { background: var(--color-projected); color: white; border-color: var(--color-projected); }
        .scenario-btn.recovery-active { background: var(--color-recovery); color: white; border-color: var(--color-recovery); }
        
        .slider-container { margin-top: 10px; }
        .slider-label { display: flex; justify-content: space-between; font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; }
        input[type=range] { width: 100%; accent-color: var(--color-projected); cursor: pointer; }

        .sim-kpi-box { flex: 1; text-align: center; }
        .sim-kpi-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); }
        .sim-kpi-value { font-size: 1.4rem; font-weight: 800; color: var(--color-projected); margin-top: 5px; }

        /* KPIs */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 35px; }
        .kpi-card { background: #fff; padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow-md); position: relative; overflow: hidden; transition: transform 0.3s; }
        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-card::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, var(--color-1), var(--color-2)); }
        .kpi-card.c2::after { background: linear-gradient(90deg, var(--color-3), var(--color-2)); }
        .kpi-card.c3::after { background: linear-gradient(90deg, var(--color-4), var(--color-1)); }
        
        .kpi-label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 10px; text-transform: uppercase; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: var(--text-primary); letter-spacing: -1px; }
        
        .trend-badge { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 700; margin-top: 12px; }
        .trend-up { background: #def7ec; color: #03543f; }
        .trend-down { background: #fde8e8; color: #9b1c1c; }
        .trend-neutral { background: #f3f4f6; color: #4b5563; }

        /* Charts & Tables */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; }
        .chart-card { background: white; padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow-md); height: 450px; display: flex; flex-direction: column; cursor: pointer; transition: border-color 0.3s; border: 2px solid transparent; }
        .chart-card:hover { border-color: rgba(107, 70, 193, 0.3); }
        
        .chart-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .chart-title-text { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .click-hint { font-size: 0.7rem; background: #edf2f7; padding: 4px 8px; border-radius: 4px; color: #718096; font-weight: 600; }
        
        .canvas-container { flex-grow: 1; position: relative; width: 100%; }

        /* Toast Notification */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #2d3748; color: #fff; text-align: center;
            border-radius: 12px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px;
            transform: translateX(-50%); box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-weight: 600;
            opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast span { color: #00DFD8; }

        /* Helpers */
        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; margin-top: 35px; }
        .section-title { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .seller-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow-md); display: flex; justify-content: space-between; align-items: center; border: 1px solid #f0f0f0; }
        .table-section { background: white; padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow-md); overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { text-align: left; padding: 15px; color: var(--text-secondary); font-size: 0.75rem; font-weight: 700; border-bottom: 2px solid #f0f0f0; }
        td { padding: 15px; border-bottom: 1px solid #f7fafc; color: var(--text-primary); }
        .badge-price { padding: 6px 12px; border-radius: 30px; font-size: 0.75rem; font-weight: 700; }
        .high-ticket { background: #e6fffa; color: #2c7a7b; }
        .mid-ticket { background: #fffaf0; color: #c05621; }
        .low-ticket { background: #fff5f5; color: #c53030; }

        @media (max-width: 1024px) { .charts-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="header-title">
                <h1>Dashboard Vendas Q1</h1>
                <p>An√°lise Premium Interativa</p>
            </div>
            
            <div class="controls-container">
                <div class="filter-group">
                    <label>Moeda</label>
                    <select id="currencySelector" onchange="changeCurrency()">
                        <option value="EUR">Euro (‚Ç¨)</option>
                        <option value="USD">D√≥lar ($)</option>
                        <option value="BRL">Real (R$)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>M√™s</label>
                    <select id="filterMonth" onchange="updateDashboard()">
                        <option value="all">Todos os Meses</option>
                        <option value="0">Janeiro</option>
                        <option value="1">Fevereiro</option>
                        <option value="2">Mar√ßo</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Regi√£o</label>
                    <select id="filterRegion" onchange="updateDashboard()"><option value="all">Todas</option></select>
                </div>
                <div class="filter-group">
                    <label>Vendedor</label>
                    <select id="filterSeller" onchange="updateDashboard()"><option value="all">Todos</option></select>
                </div>
                <div class="filter-group">
                    <label>Produto</label>
                    <select id="filterProduct" onchange="updateDashboard()"><option value="all">Todos</option></select>
                </div>
                <button class="btn-reset" onclick="resetFilters()">Limpar Filtros</button>
            </div>
        </header>

        <!-- SIMULA√á√ÉO Q2 -->
        <section class="simulation-section">
            <div class="sim-controls">
                <div class="section-header" style="margin:0 0 10px 0;">
                    <span style="font-size:1.5rem">üöÄ</span>
                    <div class="section-title">Simulador Q2 (Abr-Jun)</div>
                </div>
                <div class="scenario-buttons">
                    <button class="scenario-btn active" onclick="setScenario(0)">Tend√™ncia Atual (Baixa)</button>
                    <button class="scenario-btn" onclick="setScenario(1)">Recuperar Stock (Corre√ß√£o)</button>
                    <button class="scenario-btn" onclick="setScenario(2)">Super Bundles (Otimista)</button>
                </div>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Ajuste Crescimento</span>
                        <span id="growthValueDisplay" style="color:var(--color-projected)">0%</span>
                    </div>
                    <input type="range" id="growthSlider" min="-50" max="300" value="0" step="10" oninput="updateProjectionFromSlider()">
                </div>
                <p id="scenario-desc" style="font-size:0.8rem; color:#718096; margin-top:10px;">*Cen√°rio base: proje√ß√£o linear da queda de Mar√ßo.</p>
            </div>
            <div class="sim-results">
                <div class="sim-kpi-box">
                    <div class="sim-kpi-label">Previs√£o Q2</div>
                    <div class="sim-kpi-value" id="projRevenue">‚Ç¨ 0</div>
                </div>
                <div class="sim-kpi-box" style="border-left:1px solid #e2e8f0">
                    <div class="sim-kpi-label">Varia√ß√£o vs Q1</div>
                    <div class="sim-kpi-value" id="projDiff">0%</div>
                </div>
            </div>
        </section>

        <!-- KPIs -->
        <section class="kpi-grid">
            <div class="kpi-card c1">
                <div class="kpi-label">Fatura√ß√£o (Real)</div>
                <div class="kpi-value" id="kpiSales">‚Ç¨ 0,00</div>
                <div id="trendSales" class="trend-badge trend-neutral"><span>--%</span></div>
            </div>
            <div class="kpi-card c2">
                <div class="kpi-label">Unidades Vendidas</div>
                <div class="kpi-value" id="kpiUnits">0</div>
                <div id="trendUnits" class="trend-badge trend-neutral"><span>--%</span></div>
            </div>
            <div class="kpi-card c3">
                <div class="kpi-label">Ticket M√©dio</div>
                <div class="kpi-value" id="kpiTicket">‚Ç¨ 0,00</div>
            </div>
        </section>

        <div class="section-header">
            <span style="font-size:1.5rem">‚òÖ</span><span class="section-title">Destaques</span>
        </div>
        <section class="cards-grid" id="sellerCardsContainer"></section>

        <div class="section-header">
            <span style="font-size:1.5rem">‚ò∞</span><span class="section-title">Detalhe de Produtos</span>
        </div>
        <section class="table-section">
            <table id="productTable">
                <thead><tr><th>Produto</th><th>Pre√ßo Unit.</th><th>Qtd.</th><th>Total</th><th>Classifica√ß√£o</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- Gr√°ficos Interativos -->
        <section class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title-text">Evolu√ß√£o & Proje√ß√£o de Recupera√ß√£o</span>
                    <span class="click-hint">Clique no m√™s</span>
                </div>
                <div class="canvas-container"><canvas id="chartTime"></canvas></div>
                <div id="chartTimeSubtitle" class="trend-badge trend-neutral" style="align-self: flex-start; margin-top: 5px;">--</div>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title-text">Por Regi√£o</span>
                    <span class="click-hint">Clique na barra</span>
                </div>
                <div class="canvas-container"><canvas id="chartRegion"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title-text">Ranking Vendedores</span>
                    <span class="click-hint">Clique na barra</span>
                </div>
                <div class="canvas-container"><canvas id="chartSeller"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <span class="chart-title-text">Mix de Produtos</span>
                    <span class="click-hint">Clique na fatia</span>
                </div>
                <div class="canvas-container"><canvas id="chartProduct"></canvas></div>
            </div>
        </section>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast">Filtro Aplicado: <span id="toast-msg"></span></div>

    <script>
        // --- DADOS ---
        const rawData = [
            { id: 1, date: '2025-01-02', region: 'Norte', seller: 'Jo√£o Silva', product: 'Port√°til Pro 15"', units: 2, price: 1200, total: 2400 },
            { id: 2, date: '2025-01-05', region: 'Lisboa', seller: 'Ana Gomes', product: 'Monitor 27"', units: 5, price: 300, total: 1500 },
            { id: 3, date: '2025-01-10', region: 'Algarve', seller: 'Pedro Costa', product: 'Teclado Mec√¢nico', units: 10, price: 150, total: 1500 },
            { id: 4, date: '2025-01-15', region: 'Norte', seller: 'Jo√£o Silva', product: 'Rato Ergon√≥mico', units: 8, price: 80, total: 640 },
            { id: 5, date: '2025-01-22', region: 'Centro', seller: 'Maria Neves', product: 'Port√°til Pro 13"', units: 3, price: 1000, total: 3000 },
            { id: 6, date: '2025-02-05', region: 'Lisboa', seller: 'Ana Gomes', product: 'Port√°til Pro 15"', units: 1, price: 1200, total: 1200 },
            { id: 7, date: '2025-02-12', region: 'Algarve', seller: 'Pedro Costa', product: 'Monitor 24"', units: 4, price: 200, total: 800 },
            { id: 8, date: '2025-02-18', region: 'Centro', seller: 'Maria Neves', product: 'Docking Station', units: 6, price: 180, total: 1080 },
            { id: 9, date: '2025-03-03', region: 'Norte', seller: 'Jo√£o Silva', product: 'Headset Wireless', units: 7, price: 120, total: 840 },
            { id: 10, date: '2025-03-15', region: 'Lisboa', seller: 'Ana Gomes', product: 'Port√°til Pro 13"', units: 2, price: 1000, total: 2000 }
        ];

        let currentCurrency = 'EUR';
        const exchangeRates = { 'EUR': { rate: 1, locale: 'pt-PT', currency: 'EUR' }, 'USD': { rate: 1.05, locale: 'en-US', currency: 'USD' }, 'BRL': { rate: 6.15, locale: 'pt-BR', currency: 'BRL' } };
        let charts = {};
        let simulationState = { growthRate: 0, isRecovery: false };
        const colors = { vivid: ['#FF0080', '#7928CA', '#00DFD8', '#FF005C', '#F5A623', '#4A90E2', '#BD10E0'], actual: '#7928CA', projected: '#FF0080', recovery: '#00E096' };

        window.onload = function() {
            populateFilters();
            initCharts();
            updateDashboard();
            setScenario(0);
        };

        function formatCurrency(val) {
            const config = exchangeRates[currentCurrency];
            return new Intl.NumberFormat(config.locale, { style: 'currency', currency: config.currency }).format(val * config.rate);
        }
        function changeCurrency() { currentCurrency = document.getElementById('currencySelector').value; updateDashboard(); }

        function populateFilters() {
            const regions = [...new Set(rawData.map(d => d.region))];
            const sellers = [...new Set(rawData.map(d => d.seller))];
            const products = [...new Set(rawData.map(d => d.product))];
            fillSelect('filterRegion', regions); fillSelect('filterSeller', sellers); fillSelect('filterProduct', products);
        }
        function fillSelect(id, items) {
            const select = document.getElementById(id);
            items.forEach(item => { const opt = document.createElement('option'); opt.value = item; opt.innerText = item; select.appendChild(opt); });
        }

        function getFilteredData() {
            const r = document.getElementById('filterRegion').value;
            const s = document.getElementById('filterSeller').value;
            const p = document.getElementById('filterProduct').value;
            const m = document.getElementById('filterMonth').value;
            return rawData.filter(item => {
                const itemMonth = new Date(item.date).getMonth().toString();
                return (r === 'all' || item.region === r) && (s === 'all' || item.seller === s) && (p === 'all' || item.product === p) && (m === 'all' || itemMonth === m);
            });
        }

        function resetFilters() {
            ['filterRegion', 'filterSeller', 'filterProduct', 'filterMonth'].forEach(id => document.getElementById(id).value = 'all');
            updateDashboard();
            showToast("Filtros Removidos");
        }

        // --- CROSS-FILTERING COM TOGGLE FIX ---
        function handleChartClick(type, labelValue) {
            const selectMap = { 'region': 'filterRegion', 'seller': 'filterSeller', 'product': 'filterProduct', 'month': 'filterMonth' };
            const selectId = selectMap[type];
            const select = document.getElementById(selectId);
            
            let targetValue = labelValue;
            
            // Convers√£o especial para M√™s (Label "Jan" -> Value "0")
            if(type === 'month') {
                const months = ['Jan', 'Fev', 'Mar'];
                const idx = months.indexOf(labelValue);
                if(idx > -1) targetValue = idx.toString();
            }

            // L√≥gica de Toggle (Desfazer filtro se clicar no mesmo)
            if (select.value === targetValue) {
                select.value = 'all';
                showToast(`Filtro removido: ${labelValue}`);
            } else {
                // Tentar selecionar
                let found = false;
                for(let i=0; i<select.options.length; i++) {
                    if(select.options[i].value === targetValue || select.options[i].text === targetValue) {
                        select.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                if(found) showToast(`Filtrando por: ${labelValue}`);
                else if (type === 'month') { // For√ßa valor se for m√™s (casos de index)
                    select.value = targetValue;
                    showToast(`Filtrando por: ${labelValue}`);
                }
            }
            updateDashboard();
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            document.getElementById("toast-msg").innerText = message;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- SIMULA√á√ÉO ---
        function setScenario(type) {
            const slider = document.getElementById('growthSlider');
            const btns = document.querySelectorAll('.scenario-btn');
            const desc = document.getElementById('scenario-desc');
            
            btns.forEach(b => b.classList.remove('active', 'recovery-active'));
            
            let rate = 0;
            simulationState.isRecovery = false;

            if (type === 0) {
                rate = 0; 
                btns[0].classList.add('active');
                desc.innerText = "*Cen√°rio base: Manuten√ß√£o da tend√™ncia de Mar√ßo.";
            }
            if (type === 1) {
                rate = 110; 
                btns[1].classList.add('recovery-active');
                simulationState.isRecovery = true; // Ativa visualiza√ß√£o de melhoria
                desc.innerText = "*Cen√°rio de Corre√ß√£o: Recupera√ß√£o do n√≠vel de stock e vendas.";
            }
            if (type === 2) {
                rate = 220; 
                btns[2].classList.add('active');
                desc.innerText = "*Cen√°rio Otimista: Sucesso total na estrat√©gia de bundles.";
            }
            
            slider.value = rate;
            updateProjectionFromSlider();
        }

        function updateProjectionFromSlider() {
            const val = parseInt(document.getElementById('growthSlider').value);
            document.getElementById('growthValueDisplay').innerText = (val >= 0 ? '+' : '') + val + '%';
            simulationState.growthRate = val / 100;
            updateChartsData(getFilteredData()); 
        }

        // --- UPDATE ---
        function updateDashboard() {
            const data = getFilteredData();
            updateKPIs(data);
            updateSellerBestProducts(data);
            updateProductTable(data);
            updateChartsData(data);
        }

        function updateKPIs(data) {
            const totalSales = data.reduce((sum, item) => sum + item.total, 0);
            const totalUnits = data.reduce((sum, item) => sum + item.units, 0);
            const avgTicket = data.length > 0 ? totalSales / data.length : 0;
            document.getElementById('kpiSales').innerText = formatCurrency(totalSales);
            document.getElementById('kpiUnits').innerText = totalUnits;
            document.getElementById('kpiTicket').innerText = formatCurrency(avgTicket);
            
            const isFull = document.getElementById('filterMonth').value === 'all';
            const display = isFull && data.length > 0 ? 'inline-flex' : 'none';
            document.getElementById('trendSales').style.display = display;
            document.getElementById('trendUnits').style.display = display;
            if(isFull) calculateTrends(data);
        }

        function calculateTrends(data) {
            const monthly = {};
            data.forEach(d => { const m = new Date(d.date).getMonth(); monthly[m] = (monthly[m]||0) + d.total; });
            const months = Object.keys(monthly).map(Number).sort((a,b)=>a-b);
            const last = months[months.length-1];
            const prev = months[months.length-2];
            
            const el = document.getElementById('trendSales');
            if(!prev) { el.innerHTML = '<span>Novo</span>'; el.className='trend-badge trend-neutral'; return; }
            const p = ((monthly[last]-monthly[prev])/monthly[prev])*100;
            el.innerHTML = `<span>${p>=0?'‚ñ≤':'‚ñº'} ${Math.abs(p).toFixed(1)}%</span>`;
            el.className = `trend-badge ${p>=0?'trend-up':'trend-down'}`;
        }

        function updateSellerBestProducts(data) {
            const container = document.getElementById('sellerCardsContainer');
            container.innerHTML = '';
            if(data.length===0) { container.innerHTML='<p style="color:#777; padding:10px;">Sem dados.</p>'; return; }
            const sellers = {};
            data.forEach(d => {
                if(!sellers[d.seller]) sellers[d.seller] = { name: d.seller, total: 0, prods: {} };
                sellers[d.seller].total += d.total;
                sellers[d.seller].prods[d.product] = (sellers[d.seller].prods[d.product]||0) + d.total;
            });
            Object.values(sellers).forEach(s => {
                let best = '', max = -1;
                for(const [p,v] of Object.entries(s.prods)) if(v>max){ max=v; best=p; }
                const div = document.createElement('div');
                div.className = 'seller-card';
                div.innerHTML = `<div class="seller-info"><h4>${s.name}</h4><div class="top-product-badge">‚òÖ ${best}</div></div><div class="seller-total"><strong>${formatCurrency(s.total)}</strong></div>`;
                container.appendChild(div);
            });
        }

        function updateProductTable(data) {
            const tbody = document.querySelector('#productTable tbody');
            tbody.innerHTML = '';
            if(data.length===0) { tbody.innerHTML='<tr><td colspan="5" style="text-align:center; padding:15px;">Sem dados.</td></tr>'; return; }
            const prods = {};
            data.forEach(d => {
                if(!prods[d.product]) prods[d.product] = { name: d.product, price: d.price, units: 0, total: 0 };
                prods[d.product].units += d.units;
                prods[d.product].total += d.total;
            });
            Object.values(prods).sort((a,b)=>b.total-a.total).forEach(p => {
                const tr = document.createElement('tr');
                let badge = p.price >= 1000 ? ['high-ticket','Alto'] : (p.price>=200 ? ['mid-ticket','M√©dio'] : ['low-ticket','Baixo']);
                tr.innerHTML = `<td style="font-weight:600">${p.name}</td><td>${formatCurrency(p.price)}</td><td style="text-align:center">${p.units}</td><td style="font-weight:700;color:var(--accent-color)">${formatCurrency(p.total)}</td><td><span class="badge-price ${badge[0]}">${badge[1]}</span></td>`;
                tbody.appendChild(tr);
            });
        }

        // --- GR√ÅFICOS ---
        function initCharts() {
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.color = '#718096';
            
            const clickOption = (type) => ({
                onClick: (e, elements, chart) => {
                    if(elements.length > 0) {
                        const idx = elements[0].index;
                        const label = chart.data.labels[idx];
                        handleChartClick(type, label);
                    }
                }
            });

            const common = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, layout: { padding: 10 } };

            charts.region = new Chart(document.getElementById('chartRegion'), { type: 'bar', data: {}, options: { ...common, ...clickOption('region'), scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
            charts.seller = new Chart(document.getElementById('chartSeller'), { type: 'bar', data: {}, options: { ...common, ...clickOption('seller'), indexAxis: 'y', scales: { x: { beginAtZero: true, grid: { display: false } }, y: { grid: { display: false } } } } });
            charts.product = new Chart(document.getElementById('chartProduct'), { type: 'doughnut', data: {}, options: { ...common, ...clickOption('product'), cutout: '65%', plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } } } } });
            
            // TIME CHART (Linha)
            charts.time = new Chart(document.getElementById('chartTime'), { 
                type: 'line', data: { labels: [], datasets: [] }, 
                options: { 
                    ...common, 
                    ...clickOption('month'),
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f0f0f0' } }, x: { grid: { display: false } } },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label + ': ' + formatCurrency(context.raw);
                                    if (context.dataset.label === 'Recupera√ß√£o') label += ' (Ganho Estimado)';
                                    return label;
                                }
                            }
                        }
                    }
                } 
            });
        }

        function aggregateData(data, key) {
            const map = {};
            data.forEach(d => {
                let label = d[key];
                if (key === 'date') label = ['Jan', 'Fev', 'Mar'][new Date(d.date).getMonth()];
                map[label] = (map[label] || 0) + d.total;
            });
            return { labels: Object.keys(map), values: Object.values(map) };
        }

        function updateChartsData(data) {
            const update = (chart, agg, type) => {
                chart.data.labels = agg.labels;
                chart.data.datasets = [{ label: 'Vendas', data: agg.values, backgroundColor: colors.vivid, borderRadius: 6, barThickness: 30 }];
                if (type === 'bar') chart.data.datasets[0].backgroundColor = agg.values.map((_, i) => colors.vivid[i % colors.vivid.length]);
                if (type === 'doughnut') { chart.data.datasets[0].borderColor = 'white'; chart.data.datasets[0].borderWidth = 2; }
                chart.options.plugins.tooltip.callbacks.label = (ctx) => ' ' + formatCurrency(ctx.raw);
                chart.update();
            };

            update(charts.region, aggregateData(data, 'region'), 'bar');
            update(charts.seller, aggregateData(data, 'seller'), 'bar');
            update(charts.product, aggregateData(data, 'product'), 'doughnut');

            // Time Chart H√≠brido
            const tData = aggregateData(data, 'date');
            const order = ['Jan', 'Fev', 'Mar'];
            const actuals = [0, 0, 0];
            tData.labels.forEach((l, i) => { const idx = order.indexOf(l); if(idx > -1) actuals[idx] = tData.values[i]; });

            let baseline = actuals[2] || (actuals.reduce((a,b)=>a+b,0)/3);
            let proj = [baseline*(1+simulationState.growthRate), baseline*(1+simulationState.growthRate)*1.05, baseline*(1+simulationState.growthRate)*1.10];
            
            const isFull = document.getElementById('filterMonth').value === 'all';
            const labels = isFull ? ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'] : tData.labels;
            
            charts.time.data.labels = labels;
            
            // Datasets
            const dsActual = { label: 'Realizado', data: isFull ? [...actuals, null, null, null] : tData.values, borderColor: colors.actual, backgroundColor: colors.actual, borderWidth: 3, tension: 0.4 };
            const dsProjected = { label: 'Proje√ß√£o', data: isFull ? [null, null, baseline, ...proj] : [], borderColor: colors.projected, backgroundColor: colors.projected, borderWidth: 3, borderDash: [5, 5], tension: 0.4 };
            
            // L√≥gica de Visualiza√ß√£o da "Carencia de Produtos" (Recupera√ß√£o)
            // Se estiver no modo recupera√ß√£o, adiciona um dataset de √°rea para destacar o ganho
            let dsRecovery = null;
            if (simulationState.isRecovery && isFull) {
                // Cria uma linha "Base" (Tend√™ncia ruim) vs "Proje√ß√£o" (Recupera√ß√£o)
                // Apenas para efeito visual de preenchimento
                dsRecovery = {
                    label: 'Recupera√ß√£o de Stock',
                    data: [null, null, baseline, proj[0], proj[1], proj[2]],
                    borderColor: 'transparent',
                    backgroundColor: 'rgba(0, 224, 150, 0.2)', // Verde transparente
                    fill: 'start', // Preenche at√© ao in√≠cio (ou at√© outro dataset se configurado, simplificado aqui)
                    pointRadius: 0
                };
            }

            charts.time.data.datasets = dsRecovery ? [dsActual, dsProjected, dsRecovery] : [dsActual, dsProjected];

            // Update simulation KPIs
            if(isFull) {
                const totalQ2 = proj.reduce((a,b)=>a+b,0);
                const totalQ1 = actuals.reduce((a,b)=>a+b,0);
                const diff = totalQ1 > 0 ? ((totalQ2-totalQ1)/totalQ1)*100 : 0;
                document.getElementById('projRevenue').innerText = formatCurrency(totalQ2);
                document.getElementById('projDiff').innerText = (diff>=0?'+':'')+diff.toFixed(1)+'%';
                document.getElementById('projDiff').style.color = diff>=0 ? '#00E096' : '#FF005C';
                
                const lastVar = actuals[1] > 0 ? ((actuals[2]-actuals[1])/actuals[1])*100 : 0;
                const badge = document.getElementById('chartTimeSubtitle');
                badge.innerText = `M√™s (Real): ${lastVar>=0?'+':''}${lastVar.toFixed(1)}%`;
                badge.className = `trend-badge ${lastVar>=0?'trend-up':'trend-down'}`;
            } else {
                 document.getElementById('projRevenue').innerText = '-';
                 document.getElementById('projDiff').innerText = '-';
            }
            charts.time.update();
        }
    </script>
</body>
</html>
